name: Deploy with Checks to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: deploy-pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Type Check
        id: typecheck
        run: |
          echo "status=running" >> $GITHUB_OUTPUT
          START_TIME=$(date +%s%3N)
          if npm run type-check 2>&1 | tee typecheck.log; then
            echo "status=âœ… success" >> $GITHUB_OUTPUT
            echo "failed=false" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ failed" >> $GITHUB_OUTPUT
            echo "failed=true" >> $GITHUB_OUTPUT
            cat typecheck.log
          fi
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}ms" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ§ª Run Tests
        id: test
        run: |
          echo "status=running" >> $GITHUB_OUTPUT
          START_TIME=$(date +%s%3N)
          if npm run test:run 2>&1 | tee test.log; then
            echo "status=âœ… success" >> $GITHUB_OUTPUT
            echo "failed=false" >> $GITHUB_OUTPUT
            TEST_OUTPUT=$(cat test.log)
            PASSED=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= passed)' | tail -1 || echo "0")
            FAILED=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= failed)' | head -1 || echo "0")
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ failed" >> $GITHUB_OUTPUT
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            cat test.log
          fi
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}ms" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ” Lint Check
        id: lint
        run: |
          echo "status=running" >> $GITHUB_OUTPUT
          START_TIME=$(date +%s%3N)
          if npm run lint:ci 2>&1 | tee lint.log; then
            echo "status=âœ… success" >> $GITHUB_OUTPUT
            echo "failed=false" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ failed" >> $GITHUB_OUTPUT
            echo "failed=true" >> $GITHUB_OUTPUT
            cat lint.log
          fi
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}ms" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ—ï¸ Build Application
        id: build
        run: |
          echo "status=running" >> $GITHUB_OUTPUT
          START_TIME=$(date +%s%3N)
          if npm run build 2>&1 | tee build.log; then
            echo "status=âœ… success" >> $GITHUB_OUTPUT
            echo "failed=false" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ failed" >> $GITHUB_OUTPUT
            echo "failed=true" >> $GITHUB_OUTPUT
            cat build.log
          fi
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}ms" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“Š Generate Deployment Summary
        if: always()
        run: |
          echo "# ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Type Check | ${{ steps.typecheck.outputs.status || 'â­ï¸ skipped' }} | ${{ steps.typecheck.outputs.duration || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ steps.test.outputs.status || 'â­ï¸ skipped' }} | ${{ steps.test.outputs.duration || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Lint | ${{ steps.lint.outputs.status || 'â­ï¸ skipped' }} | ${{ steps.lint.outputs.duration || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build | ${{ steps.build.outputs.status || 'â­ï¸ skipped' }} | ${{ steps.build.outputs.duration || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.passed }}" != "" ]; then
            echo "### ğŸ§ª Test Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Tests Passed:** ${{ steps.test.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tests Failed:** ${{ steps.test.outputs.failed || '0' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Check if any step failed
          if [ "${{ steps.typecheck.outputs.failed }}" == "true" ] || [ "${{ steps.test.outputs.failed }}" == "true" ] || [ "${{ steps.lint.outputs.failed }}" == "true" ] || [ "${{ steps.build.outputs.failed }}" == "true" ]; then
            echo "## âŒ Status: DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ One or more checks failed. Please fix the issues before deploying." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Checks:" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.typecheck.outputs.failed }}" == "true" ] && echo "- âŒ Type Check" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.test.outputs.failed }}" == "true" ] && echo "- âŒ Tests" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.lint.outputs.failed }}" == "true" ] && echo "- âŒ Lint" >> $GITHUB_STEP_SUMMARY
            [ "${{ steps.build.outputs.failed }}" == "true" ] && echo "- âŒ Build" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Status: READY TO DEPLOY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ All checks passed successfully! The application is ready for deployment." >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ Stop deployment if checks failed
        if: steps.typecheck.outputs.failed == 'true' || steps.test.outputs.failed == 'true' || steps.lint.outputs.failed == 'true' || steps.build.outputs.failed == 'true'
        run: |
          echo "Deployment blocked due to failed checks"
          exit 1

      - name: âœ… Validate build artifact exists
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Validating ./dist exists..."
          if [ ! -d "./dist" ]; then
            echo "Build artifact not found at ./dist. Please check the build step and output path."
            exit 1
          fi
          echo "Contents of ./dist:"
          ls -la ./dist || true

      - name: ğŸ“¤ Upload build artifact (for debug)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ./dist
          retention-days: 7

      - name: ğŸ”’ Check if GitHub Pages is enabled
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          REPO_API: https://api.github.com/repos/${{ github.repository }}/pages
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github+json" "$REPO_API" || true)
          if [ "$STATUS" -eq 404 ]; then
            echo "GitHub Pages is not enabled for this repository."
            echo "Please enable GitHub Pages in your repository settings: https://github.com/${{ github.repository }}/settings/pages"
            exit 1
          fi

      - name: âš™ï¸ Configure GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/configure-pages@v3

      - name: ğŸ“¦ Upload artifact for deployment
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-pages-artifact@v4
        with:
          path: './dist'

      - name: ğŸš€ Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const typecheck = '${{ steps.typecheck.outputs.status }}' || 'â­ï¸ skipped';
            const test = '${{ steps.test.outputs.status }}' || 'â­ï¸ skipped';
            const lint = '${{ steps.lint.outputs.status }}' || 'â­ï¸ skipped';
            const build = '${{ steps.build.outputs.status }}' || 'â­ï¸ skipped';

            const passed = '${{ steps.test.outputs.passed }}' || '0';
            const failed = '${{ steps.test.outputs.failed }}' || '0';

            const allPassed = typecheck.includes('âœ…') && test.includes('âœ…') && lint.includes('âœ…') && build.includes('âœ…');

            const body = `## ğŸš€ Deployment Check Results

            | Check | Status | Duration |
            |-------|--------|----------|
            | ğŸ” Type Check | ${typecheck} | ${{ steps.typecheck.outputs.duration || '-' }} |
            | ğŸ§ª Tests | ${test} | ${{ steps.test.outputs.duration || '-' }} |
            | ğŸ” Lint | ${lint} | ${{ steps.lint.outputs.duration || '-' }} |
            | ğŸ—ï¸ Build | ${build} | ${{ steps.build.outputs.duration || '-' }} |

            ### Test Results
            - âœ… Tests Passed: ${passed}
            - âŒ Tests Failed: ${failed}

            ${allPassed ? 'âœ… **All checks passed!** This PR is ready to merge.' : 'âŒ **Some checks failed.** Please review and fix the issues before merging.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
